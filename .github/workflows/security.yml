name: Security

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write # Required for dependency graph submission
  actions: read
  id-token: write # Required for OIDC authentication

jobs:
  dependency-check:
    name: Dependency Vulnerability Check
    runs-on: ubuntu-latest

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
      with:
        egress-policy: audit

    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Set up GraalVM
      uses: graalvm/setup-graalvm@eec48106e0bf45f2976c2ff0c3e22395cced8243 # v1.4.2
      with:
        java-version: '21'
        distribution: 'graalvm'
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@ed408507eac070d1f99cc633dbcf757c94c7933a # v4.4.3
      with:
        validate-wrappers: true
        cache-read-only: ${{ github.ref != 'refs/heads/main' }}
        dependency-graph: ${{ github.event_name == 'push' && 'generate-and-submit' || 'disabled' }}
        dependency-graph-continue-on-failure: true

    - name: Generate SBOM (CycloneDX)
      id: sbom_generation
      run: |
        # Disable configuration cache for SBOM generation due to GraalVM plugin incompatibility
        # See: https://github.com/kamiazya/scopes/issues/36
        ./gradlew --no-daemon --no-configuration-cache --scan :apps-scopes:cycloneDxBom
      continue-on-error: ${{ github.event_name == 'pull_request' }}

    - name: Handle SBOM generation failure
      if: steps.sbom_generation.outcome == 'failure'
      run: |
        echo "SBOM generation failed"
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "::warning::SBOM generation failed - this is non-blocking for PRs but should be investigated"
          exit 0
        else
          echo "::error::SBOM generation failed on main branch - this will fail the workflow"
          exit 1
        fi

    - name: Upload SBOM artifacts
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      if: always()
      with:
        name: sbom-cyclonedx
        path: |
          apps/scopes/build/reports/
        if-no-files-found: warn

    - name: Comment PR with vulnerability summary
      if: github.event_name == 'pull_request' && steps.sbom_generation.outcome == 'failure'
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      env:
        HEAD_REF: ${{ github.head_ref || github.ref_name }}
        SERVER_URL: ${{ github.server_url }}
        REPOSITORY: ${{ github.repository }}
        RUN_ID: ${{ github.run_id }}
      with:
        script: |
          const comment = `## ⚠️ Security Issues Detected

          The security check found issues during SBOM generation or dependency analysis.

          Please review the [security check workflow](${process.env.SERVER_URL}/${process.env.REPOSITORY}/actions/runs/${process.env.RUN_ID}) for details.

          **Next steps:**
          1. Check the Security tab for Dependabot alerts
          2. Review any failed SBOM generation steps
          3. Update vulnerable dependencies as needed

          For more information, see [Security Policy](${process.env.SERVER_URL}/${process.env.REPOSITORY}/blob/${process.env.HEAD_REF}/SECURITY.md).`;

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });


