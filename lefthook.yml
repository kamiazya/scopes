# Lefthook configuration for Scopes project
# https://github.com/evilmartians/lefthook

pre-commit:
  parallel: true
  commands:
    editorconfig:
      glob: "*"
      exclude: '.claude/.*|tmp/.*|LICENSE'
      run: |
        docker run --rm -v "$(pwd):/workspace" \
          -w /workspace \
          mstruebing/editorconfig-checker:latest \
          ec --exclude LICENSE \
          {staged_files} || true
      skip:
        - merge
        - rebase

    ktlint:
      glob: "**/*.kt"
      run: ./gradlew ktlintFormat --daemon
      stage_fixed: true
      skip:
        - merge
        - rebase

    detekt:
      glob: "**/*.kt"
      run: ./gradlew detekt --daemon
      skip:
        - merge
        - rebase

    kotlin-test:
      glob: "**/*.kt"
      run: ./gradlew test --daemon
      skip:
        - merge
        - rebase

# Claude Code integration - runs after file edits
post-tool-use-edit:
  parallel: true
  commands:
    ktlint-format:
      glob: "**/*.kt"
      run: |
        echo "üîß Auto-formatting Kotlin file: {files}"
        ./gradlew ktlintFormat --daemon --quiet
        echo "‚úÖ KtLint formatting completed"
      
    detekt-check:
      glob: "**/*.kt"
      run: |
        echo "üîç Running Detekt analysis with auto-correction"
        ./gradlew detekt -Pdetekt.autoCorrect=true --daemon --quiet || true
        echo "‚úÖ Detekt analysis completed"
      
    # Optional: Run tests for the affected module only
    module-test:
      glob: "**/*.kt"
      run: |
        # Extract module from file path and run tests for that module only
        MODULE_PATH=$(echo "{file}" | cut -d'/' -f1)
        if [ -f "$MODULE_PATH/build.gradle.kts" ]; then
          echo "Running tests for module: $MODULE_PATH"
          ./gradlew :$MODULE_PATH:test --daemon --quiet
        else
          echo "No module found for {file}, skipping tests"
        fi

# Skip hooks during CI/CD
skip_output:
  - meta
  - success
