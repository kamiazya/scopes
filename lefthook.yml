# Lefthook configuration for Scopes project
# https://github.com/evilmartians/lefthook

pre-commit:
  parallel: true
  commands:
    spotless:
      glob: "**/*.{kt,kts,md,yml,yaml,json}"
      run: |
        echo "üé® Running Spotless formatting..."
        # Get list of staged files before formatting
        STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(kt|kts|md|yml|yaml|json)$' || true)

        if [ -n "$STAGED_FILES" ]; then
          # Run Spotless
          ./gradlew spotlessApply --daemon

          # Re-stage any files that were modified by Spotless
          for file in $STAGED_FILES; do
            if [ -f "$file" ]; then
              git add "$file"
              echo "üìù Re-staged: $file"
            fi
          done
        fi
        echo "‚úÖ Spotless formatting completed"
      skip:
        - merge
        - rebase

    editorconfig:
      glob: "*"
      exclude: '.claude/.*|tmp/.*|LICENSE'
      run: |
        docker run --rm -v "$(pwd):/workspace" \
          -w /workspace \
          mstruebing/editorconfig-checker:latest \
          ec --exclude LICENSE \
          {staged_files} || true
      skip:
        - merge
        - rebase

    ktlint:
      glob: "**/*.kt"
      run: |
        echo "üîß Running KtLint formatting..."
        # Get list of staged Kotlin files
        STAGED_KT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.kt$' || true)

        if [ -n "$STAGED_KT_FILES" ]; then
          # Run ktlint
          ./gradlew ktlintFormat --daemon

          # Re-stage any files that were modified
          for file in $STAGED_KT_FILES; do
            if [ -f "$file" ]; then
              git add "$file"
              echo "üìù Re-staged: $file"
            fi
          done
        fi
        echo "‚úÖ KtLint formatting completed"
      skip:
        - merge
        - rebase

    detekt:
      glob: "**/*.kt"
      run: ./gradlew detekt --daemon
      skip:
        - merge
        - rebase

    kotlin-test:
      glob: "**/*.kt"
      run: ./gradlew test --daemon
      skip:
        - merge
        - rebase

# Claude Code integration - runs after file edits
post-tool-use-edit:
  parallel: true
  commands:
    spotless-format:
      glob: "**/*.{kt,kts,md,yml,yaml,json}"
      run: |
        echo "üé® Auto-formatting files with Spotless: {files}"
        ./gradlew spotlessApply --daemon --quiet
        echo "‚úÖ Spotless formatting completed"

    ktlint-format:
      glob: "**/*.kt"
      run: |
        echo "üîß Auto-formatting Kotlin file: {files}"
        ./gradlew ktlintFormat --daemon --quiet
        echo "‚úÖ KtLint formatting completed"

    detekt-check:
      glob: "**/*.kt"
      run: |
        echo "üîç Running Detekt analysis with auto-correction"
        ./gradlew detekt -Pdetekt.autoCorrect=true --daemon --quiet || true
        echo "‚úÖ Detekt analysis completed"

    # Optional: Run tests for the affected module only
    module-test:
      glob: "**/*.kt"
      run: |
        # Extract module from file path and run tests for that module only
        MODULE_PATH=$(echo "{file}" | cut -d'/' -f1)
        if [ -f "$MODULE_PATH/build.gradle.kts" ]; then
          echo "Running tests for module: $MODULE_PATH"
          ./gradlew :$MODULE_PATH:test --daemon --quiet
        else
          echo "No module found for {file}, skipping tests"
        fi

# Skip hooks during CI/CD
skip_output:
  - meta
  - success
